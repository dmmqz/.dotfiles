#!/usr/bin/env python3
"""i3blocks media player block.

The main aim is to handle cmus, playerctl is a fallback for other media players.
"""

import os
import subprocess

BLOCK_INSTANCE = os.environ.get("BLOCK_INSTANCE", "")
BLOCK_BUTTON = os.environ.get("BLOCK_BUTTON", "")


def run_command(
    args: list[str], *, suppress_stderr: bool = False
) -> subprocess.CompletedProcess[str]:
    try:
        return subprocess.run(
            args,
            stdout=subprocess.PIPE,
            text=True,
            stderr=subprocess.DEVNULL if suppress_stderr else subprocess.PIPE,
            check=False,
        )
    except FileNotFoundError:
        return subprocess.CompletedProcess(
            args=args, returncode=127, stdout="", stderr=""
        )


def playerctl_args() -> list[str]:
    if BLOCK_INSTANCE:
        return ["--player", BLOCK_INSTANCE]
    return []


def handle_cmus_buttons() -> None:
    if BLOCK_BUTTON == "1":
        run_command(["cmus-remote", "--prev"])
    elif BLOCK_BUTTON == "2":
        run_command(["cmus-remote", "--pause"])
    elif BLOCK_BUTTON == "3":
        run_command(["cmus-remote", "--next"])


def handle_playerctl_buttons() -> None:
    args = playerctl_args()
    if BLOCK_BUTTON == "1":
        run_command(["playerctl", *args, "previous"])
    elif BLOCK_BUTTON == "2":
        run_command(["playerctl", *args, "play-pause"])
    elif BLOCK_BUTTON == "3":
        run_command(["playerctl", *args, "next"])
    elif BLOCK_BUTTON == "4":
        run_command(["playerctl", *args, "volume", "0.01+"])
    elif BLOCK_BUTTON == "5":
        run_command(["playerctl", *args, "volume", "0.01-"])


def cmus_output() -> str | None:
    handle_cmus_buttons()

    cmus = run_command(["cmus-remote", "--query"])
    if cmus.returncode != 0:
        return None

    status = ""
    artist = ""
    title = ""
    for line in cmus.stdout.splitlines():
        parts = line.split()
        if len(parts) == 2 and parts[0] == "status":
            status = parts[1].capitalize()
        elif len(parts) >= 3 and parts[0] == "tag":
            key = parts[1]
            value = " ".join(parts[2:])
            if key == "artist":
                artist = value
            elif key == "title":
                title = value

    if not (artist or title):
        return None

    if not status:
        status = "Playing"
    return f"{status}: {artist} - {title}"


def playerctl_output() -> str | None:
    handle_playerctl_buttons()
    args = playerctl_args()

    artist_result = run_command(
        ["playerctl", *args, "metadata", "artist"], suppress_stderr=True
    )
    artist = artist_result.stdout.strip()
    if artist_result.returncode != 0 or artist == "(null)":
        return None

    title_result = run_command(
        ["playerctl", *args, "metadata", "title"], suppress_stderr=True
    )
    title = title_result.stdout.strip()
    if title_result.returncode != 0 or title == "(null)":
        return None

    metadata = [item for item in (artist, title) if item]
    if not metadata:
        return None

    return " - ".join(metadata)


def main() -> int:
    if "cmus" in BLOCK_INSTANCE:
        output = cmus_output()
    else:
        output = playerctl_output()

    if output is None:
        return 0

    print(output)
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
